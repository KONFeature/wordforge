# AGENTS.md - WordForge Development Guide

**Generated:** 2026-01-08 | **Branch:** cleanup | **Commit:** 8c9c764

## Project Overview

WordForge: AI-powered WordPress management via MCP (Model Context Protocol). Bun monorepo with 4 packages.

## Structure

```
wordforge/
├── packages/
│   ├── php/                  # WordPress plugin (PHP 8.0+, WPCS)
│   │   ├── includes/Abilities/   # MCP tools (30 abilities)
│   │   ├── includes/Admin/       # WP admin UI controllers
│   │   ├── includes/Mcp/         # MCP server integration
│   │   └── includes/OpenCode/    # OpenCode binary manager
│   ├── ui/                   # React admin UI (WordPress bundled React)
│   │   ├── src/chat/             # Full chat interface
│   │   ├── src/settings/         # Settings page
│   │   ├── src/widget/           # Floating widget
│   │   └── src/editor/           # Gutenberg sidebar
│   └── desktop/              # Tauri desktop app (React + Rust)
│       ├── src/                  # React frontend (TanStack Router/Query)
│       └── src-tauri/            # Rust backend (OpenCode sidecar)
├── biome.json                # Shared TS/JS linting
├── build.sh                  # Root build script
└── package.json              # Bun workspaces
```

**Note:** `packages/mcp/` does NOT exist. MCP server is via `wordpress/mcp-adapter` in PHP.

## Commands

```bash
# Root
bun install                   # Install all deps
bun run build                 # Build all (UI → PHP assets)
bun run lint                  # Lint TS/JS (Biome)
bun run lint:fix              # Auto-fix
bun run typecheck             # Type-check all
bun run start                 # wp-env (localhost:8888)

# Package-specific
cd packages/mcp && bun run build && bun run test
cd packages/ui && bun run build        # → ../php/assets/js/
cd packages/php && composer run lint:php
cd packages/desktop && bun run tauri:dev
```

## Code Style

### TypeScript (Biome)
- 2-space indent, single quotes, semicolons
- `import type` for type-only imports
- `camelCase` vars, `PascalCase` types, `SCREAMING_SNAKE_CASE` constants
- **Never** `as any`, `@ts-ignore`, `@ts-expect-error`

### React Import Rules (CRITICAL)

| Package | Import From | Why |
|---------|-------------|-----|
| `@wordforge/ui` | `@wordpress/element` | WordPress bundled React |
| `@wordforge/desktop` | `react` | Standard React (Tauri) |

```typescript
// @wordforge/ui - ALWAYS WordPress React
import { useState } from '@wordpress/element';
import { Button } from '@wordpress/components';

// @wordforge/desktop - Standard React
import { useState } from 'react';
import { useQuery } from '@tanstack/react-query';
```

### PHP (WordPress Coding Standards)
- **Tabs** for indentation
- Spaces inside parens: `function_name( $arg )`
- Yoda conditions: `if ( 'value' === $var )`
- PHP 8.0+ type declarations required
- Prefix hooks with `wordforge_`

## Architecture

### MCP Integration Flow

```
AI Client → MCP Protocol → /wp-json/wordforge/mcp → ServerManager
                                                      ↓
                                              AbilityRegistry
                                                      ↓
                                              Abilities/* → WordPress APIs
```

### Ability Pattern (PHP)

```php
class MyAbility extends AbstractAbility {
    public function get_title(): string { return 'My Tool'; }
    public function get_description(): string { return 'For AI agents'; }
    public function get_input_schema(): array { return [...]; }
    public function execute( array $args ): array {
        return $this->success( $data ) or $this->error( 'msg', 'code' );
    }
}
// Register in AbilityRegistry.php
```

### Desktop IPC Flow

```
React (invoke) → Tauri Commands → Rust Backend
React (listen) ← Tauri Events   ← Rust Backend
```

## Anti-Patterns (THIS PROJECT)

| Don't | Why |
|-------|-----|
| `import from 'react'` in UI package | Must use `@wordpress/element` |
| `import from '@wordpress/element'` in desktop | Must use `react` |
| Edit `.asset.php` files | Auto-generated by wp-scripts |
| Edit `routeTree.gen.ts` | Auto-generated by TanStack Router |
| `as any`, `@ts-ignore` | Type safety required |
| Deploy full monorepo to WP | Only `packages/php/` contents |
| Skip Yoda conditions in PHP | WPCS requires them |

## Where to Look

| Task | Location |
|------|----------|
| Add MCP ability | `packages/php/includes/Abilities/` + `AbilityRegistry.php` |
| Modify chat UI | `packages/ui/src/chat/` |
| Change settings | `packages/ui/src/settings/` |
| Desktop features | `packages/desktop/src/` (React) + `src-tauri/` (Rust) |
| OpenCode management | `packages/php/includes/OpenCode/` |
| Build/deploy plugin | `packages/php/build.sh` |

## Testing

Tests in `packages/mcp/test/` using Vitest. Globals enabled.

```typescript
describe('MyFeature', () => {
  it('should work', async () => {
    const result = await client.executeAbility('wordforge/my-ability', 'GET', {});
    expect(result.success).toBe(true);
  });
});
```

**Integration env vars** (`.env` in packages/mcp):
```
TEST_WORDPRESS_URL=https://example.com/wp-json/wp-abilities/v1
TEST_WORDPRESS_USER=admin
TEST_WORDPRESS_PASS=xxxx xxxx xxxx
```

## Common Pitfalls

1. **React imports** - Wrong package = runtime errors
2. **PHP "undefined function"** - WordPress functions work at runtime, not static analysis
3. **Asset files** - `.asset.php` auto-generated, don't edit
4. **Deploying** - Only `packages/php/` goes to WordPress
5. **Missing tests** - Test infrastructure exists but sparse coverage
